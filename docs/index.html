<!DOCTYPE html>
<html lang="ja">
<head>

<meta charset="UTF-8"/>
<script type="text/javascript" src="//code.jquery.com/jquery-2.2.4.min.js"></script>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"/>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
<script src="./js/qrcode.min.js"></script>

<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="apple-mobile-web-app-title" content="Custom QR Code Generator"/>

<title>カスタムQRコード生成</title>

<style type="text/css">
body{
  text-align: center;
}
.mycanvas{
  border: 1px solid #333;
}
</style>

<script>
var img_width = 100;
$(function(){
  // ファイルを選択した場合
  var selfInput = $(this).find( 'input[type=file]' );
  selfInput.change( function(){
    var file = $(this).prop('files')[0];
    if( !file.type.match( /image\/\w+/ ) ){
      alert( '画像ファイル以外は利用できません' );
      return;
    }

    $('#image_preview').attr( "src", "" );
    var reader = new FileReader();
    if( this.files.length ){
      if( file.type.match('image.*') ){
        reader.onload = function(){
          var img = new Image();
          img.src = reader.result;
          img.addEventListener( 'load', function(){
            $('#image_preview').attr( "src", img.src );
            
            var w = img.width;
            var h = img.height;

            h = Math.round( img_width * h / w );
            w = img_width;
        
            $("#image_preview").attr( 'width', w );
            $("#image_preview").attr( 'height', h );
          }, false );
        };
        reader.onerror = function( e ){
          console.log( 'error: ' + e );
        };
        reader.readAsDataURL( file );
      }else{
        if( 0 < selfImg.size() ){
          return;
        }
      }
    }
  });
  $('#custom_image').change( function(){
    var custom_image_no = $('#custom_image').val();
    if( custom_image_no ){
      $('#image_preview').attr( "src", '/imgs/qr_embed_0' + custom_image_no + '.png' );
    }else{
      $('#image_preview').attr( "src", "" );
    }
  });

  $('#qr_width').on( 'input change', function(){
    var qr_width = parseInt( $('#qr_width').val() );
    $('#qr_width_label').html( qr_width );
  });
});

function generateCustomQRCode(){
  var text = $('#text').val();
  if( text ){
    var qr_front_color = $('#qr_front_color').val();
    var qr_back_color = $('#qr_back_color').val();
    var qr_error_correction_level = $('#qr_error_correction_level').val();
    var qr_width = parseInt( $('#qr_width').val() );
    QRCode.toCanvas( document.getElementById( 'qrcode' ), text, { errorCorrectionLevel: qr_error_correction_level, width: qr_width, color: { dark: qr_front_color, light: qr_back_color } }, function( err ){
      if( err ){ 
        console.log( err ); 
      }else{
        var canvas = document.getElementById( 'qrcode' );
        if( !canvas || !canvas.getContext ){
          return false;
        }
        var ctx = canvas.getContext( '2d' );

        var image_preview_src = $('#image_preview').attr( 'src' );
        if( image_preview_src ){
          var icon = new Image();
          icon.onload = function(){
            //. http://www.htmq.com/canvas/drawImage_s.shtml
            //. √7 ≒ 2.64
            //. √15 ≒ 3.87
            //. √25 ＝ 5
            //. √30 ≒ 5.47
            var idx = -1;
            switch( qr_error_correction_level ){
            case 'H':
              idx = 0;
              break;
            case 'Q':
              idx = 1;
              break;
            case 'M':
              idx = 2;
              break;
            case 'L':
              idx = 3;
              break;
            }
            if( idx > -1 ){
              //var image_ratio = [ 5.47, 5.00, 3.87, 2.64 ][idx];  //. 仕様上の理論値
              //var image_ratio = [ 3.79, 3.26, 2.52, 1.66 ][idx];  //. iPhone7 標準カメラでギリ認識する値
              var image_ratio = [ 3.77, 3.24, 2.50, 1.64 ][idx];
              var dw = Math.floor( image_ratio * canvas.width / 10 );
              var dh = Math.floor( image_ratio * canvas.height / 10 );
              var dx = Math.floor( ( canvas.width - dw ) / 2 );
              var dy = Math.floor( ( canvas.height - dh ) / 2 );
              ctx.drawImage( icon, 0, 0, icon.width, icon.height, dx, dy, dw, dh );
            }
          };
          icon.src = image_preview_src;
        }
      }
    });
  }
}

function resetFrontImage(){
  $('#image_preview').attr( 'src', '' );
}

function downloadImage(){
  var canvas = document.getElementById( 'qrcode' );
  if( !canvas || !canvas.getContext ){
    return false;
  }

  var link = document.createElement( 'a' );
  link.href = canvas.toDataURL( "image/png" );
  link.download = ( new Date() ).getTime() + '.png';
  link.click();
}
</script>
</head>
<body>

<nav class="navbar navbar-expand-sm navbar-light bg-light" id="jobnav">
  <a class="navbar-brand" href="/">カスタムQRコード生成</a>
</nav>

<div class="container" style="position:relative; padding-top:50px;">
  <a href="#" onClick="downloadImage();">
  <canvas id="qrcode"></canvas>
  </a>
</div>

<div class="container" style="position:relative; padding-top:50px;">

<table class="table table-bordered">
  <tr><td>
  QRコードに含める情報
  </td><td>
  <input type="text" class="form-control" id="text" placeholder="text, url, ..." value="https://dotnsf.github.io/qrgenerator/"/>
  </td></tr>
  <tr><td>
  誤り訂正レベル
  </td><td>
  <select class="form-control" id="qr_error_correction_level">
    <option value="H">H(30%)</option>
    <option value="Q">Q(25%)</option>
    <option value="M" selected>M(15%)</option>
    <option value="L">L(7%)</option>
  </select>
  </td></tr>
  <tr><td>
  画像サイズ
  </td><td>
  <input type="range" style="width: 80%;" id="qr_width" name="qr_width" min="64" max="512" step="16" value="512"/>
  <label for="qr_width" id="qr_width_label">512</label>
  </td></tr>
  <tr><td>
  色
  </td><td>
  前景
  <input type="color" class="form-control" id="qr_front_color" value="#000000"/>
  背景
  <input type="color" class="form-control" id="qr_back_color" value="#ffffff"/>
  </td></tr>
  <tr><td>
  カスタム画像
  </td><td>
  <table class="table">
  <tr><td width="100">
  <img src="" id="image_preview" width="100"/>
  </td><td>
  <input type="file" class="form-control" id="qr_front_image" value=""/>
  <input type="button" class="btn btn-warning" value="Reset" onClick="resetFrontImage();"/>
  </td></tr>
  </table>
  </td></tr>
  <tr><td colspan="2">
  <button class="btn btn-primary" onClick="generateCustomQRCode();">生成</button>
  </td></tr>
</table>

</div>

</body>

</html>